name: Build APK

on: push: branches: [ main ] workflow_dispatch:

jobs: build-android: runs-on: ubuntu-latest

steps:
  - name: Checkout Repo
    uses: actions/checkout@v3

  - name: Set up Java 17
    uses: actions/setup-java@v3
    with:
      distribution: temurin
      java-version: '17'

  - name: Set up Node.js
    uses: actions/setup-node@v3
    with:
      node-version: '20'

  - name: Clean install with fixes
    run: |
      rm -rf node_modules package-lock.json
      npm install ajv@8.11.0 ajv-keywords@5 --save
      npm install --legacy-peer-deps

  - name: Install Capacitor Android Platform
    run: npm install @capacitor/android@5 --legacy-peer-deps

  - name: Build React app
    run: npm run build

  - name: Add Android platform
    run: |
      if [ ! -d "./android" ]; then
        npx cap add android
      fi

  - name: Sync Capacitor
    run: npx cap sync android

  - name: Build APK with Gradle
    run: cd android && ./gradlew assembleDebug

  - name: Upload APK artifact
    uses: actions/upload-artifact@v4
    with:
      name: app-debug.apk
      path: android/app/build/outputs/apk/debug/app-debug.apk

